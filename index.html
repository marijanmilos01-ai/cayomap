<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cayo Perico Interactive Map</title>

<style>
html, body {
  margin:0; padding:0;
  user-select:none;
  overflow:hidden;
  font-family: Arial, sans-serif;
}

#map-container {
  position:relative;
  width:100vw;
  height:100vh;
  background:url('compound_map.png') no-repeat center center;
  background-size:cover;
}

.zone {
  position:absolute;
  border:2px solid #ccc;
  background-color: rgba(200,200,200,0.3);
  cursor:pointer;
  box-sizing:border-box;
  border-radius:8px;
}
.zone:hover {
  border-color:#ddd;
  background-color: rgba(220,220,220,0.4);
}

.symbol {
  position:absolute;
  width:30%;
  height:45%;
  display:flex;
  justify-content:center;
  align-items:center;
  cursor:pointer;
  border-radius:50%;
}
.symbol:hover {
  transform: scale(1.1);
  background-color: rgba(255,255,255,0.4);
}

.panel {
  position:absolute;
  background: rgba(30,30,30,0.9);
  color:#fff;
  padding:10px;
  border-radius:8px;
  display:none;
  z-index:10;
  min-width:120px;
}

#info-panel {
  position:absolute;
  top:0; left:0;
  width:300px;
  max-height:100vh;
  background: rgba(30,30,30,0.9);
  border-radius:8px;
  overflow:hidden;
  z-index:20;
  color:#fff;
}
#info-header {
  padding:8px;
  background: rgba(50,50,50,0.95);
  cursor:pointer;
  font-weight:bold;
}
#info-content {
  padding:8px;
}

.loot-table {
  width:100%;
  border-collapse:collapse;
  margin-bottom:10px;
}
.loot-table th,
.loot-table td {
  border:1px solid rgba(255,255,255,0.2);
  padding:4px;
  text-align:center;
}
</style>
</head>

<body>

<div id="info-panel">
  <div id="info-header">Info Panel ▲</div>
  <div id="info-content">
    <table class="loot-table">
      <tr><th>Loot</th><th>Normal</th><th>Hard</th></tr>
      <tr><td>Tequila</td><td>630k</td><td>693k</td></tr>
      <tr><td>Ruby</td><td>700k</td><td>770k</td></tr>
      <tr><td>Bonds</td><td>770k</td><td>847k</td></tr>
      <tr><td>Diamond</td><td>1.3mil</td><td>1.43mil</td></tr>
      <tr><td>Panther</td><td>1.9mil</td><td>2.09mil</td></tr>
    </table>

    <table class="loot-table">
      <tr><th>Loot</th><th>%Bag</th><th>Value Stack</th></tr>
      <tr><td>Cash</td><td>25%</td><td>$78k–$89k</td></tr>
      <tr><td>Painting</td><td>50%</td><td>$176k–$199k</td></tr>
      <tr><td>Gold</td><td>66.7%</td><td>$328k–$333k</td></tr>
      <tr><td>Weed</td><td>37.5%</td><td>$145k–$149k</td></tr>
      <tr><td>Coke</td><td>50%</td><td>$220k–$225k</td></tr>
    </table>

    <div id="notes-container"></div>
    <input id="note-input" placeholder="Add a note...">
  </div>
</div>

<div id="map-container">
  <div class="zone" style="left:47%;top:54%;width:6%;height:5%;" data-name="Podrum"></div>
  <div class="zone" style="left:45%;top:48%;width:6%;height:5%;" data-name="Office"></div>
  <div class="zone" style="left:53%;top:46%;width:6%;height:5%;" data-name="North Storage"></div>
  <div class="zone" style="left:63%;top:62%;width:6%;height:5%;" data-name="West Storage"></div>
  <div class="zone" style="left:47%;top:65%;width:6%;height:5%;" data-name="South Storage"></div>
</div>

<div id="panel" class="panel">
  <h3 id="panel-title"></h3>
  <button data-symbol="Gold">Gold</button>
  <button data-symbol="Cash">Cash</button>
  <button data-symbol="Painting">Painting</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {

  const sb = supabase.createClient(
    'https://qanrnafvvnmimewtxrxv.supabase.co',
    'sb_publishable_8F3cI7ZKCgpxv6UfaRJn7A_r1s17TmC'
  );

  const zones = document.querySelectorAll('.zone');
  const panel = document.getElementById('panel');
  const panelTitle = document.getElementById('panel-title');
  const infoPanel = document.getElementById('info-panel');
  const infoHeader = document.getElementById('info-header');
  const infoContent = document.getElementById('info-content');
  const notesContainer = document.getElementById('notes-container');
  const noteInput = document.getElementById('note-input');

  let activeZone = null;
  let collapsed = false;
  const localInsertedSymbols = new Set();

  zones.forEach(zone => {
    zone.addEventListener('click', e => {
      e.stopPropagation();
      activeZone = zone;
      panelTitle.textContent = zone.dataset.name;
      const r = zone.getBoundingClientRect();
      panel.style.left = r.left + 'px';
      panel.style.top = (r.bottom + 10) + 'px';
      panel.style.display = 'block';
    });
  });

  document.addEventListener('click', e => {
    if (panel.contains(e.target) || infoPanel.contains(e.target)) return;
    panel.style.display = 'none';
    activeZone = null;
  });

  infoHeader.addEventListener('click', e => {
    e.stopPropagation();
    collapsed = !collapsed;
    infoContent.style.display = collapsed ? 'none' : 'block';
    infoHeader.innerHTML = collapsed ? 'Info Panel &#9660;' : 'Info Panel &#9650;';
  });

  function renderSymbol(zone, type, id) {
    if (zone.querySelector(`.symbol[data-id="${id}"]`)) return;
    const idx = zone.querySelectorAll('.symbol').length;
    if (idx >= 6) return;

    const symbol = document.createElement('div');
    symbol.className = 'symbol';
    symbol.dataset.id = id;

    const row = idx < 3 ? 0 : 1;
    const col = idx % 3;
    symbol.style.top = `${row * 50 + 2}%`;
    symbol.style.left = `${col * 33 + 1}%`;

    const icons = {
      Gold: 'https://www.svgrepo.com/show/323883/gold-bar.svg',
      Cash: 'https://www.svgrepo.com/show/507663/dollar-circle.svg',
      Painting: 'https://www.svgrepo.com/show/535548/painting.svg'
    };

    symbol.innerHTML = `<img src="${icons[type]}" width="100%" height="100%">`;

    symbol.onclick = async e => {
      e.stopPropagation();
      await sb.from('symbols').delete().eq('id', id);
    };

    zone.appendChild(symbol);
  }

  panel.querySelectorAll('button').forEach(btn => {
    btn.addEventListener('click', async e => {
      e.stopPropagation();
      if (!activeZone) return;

      const region = activeZone.dataset.name;

      const { count } = await sb
        .from('symbols')
        .select('*', { count: 'exact', head: true })
        .eq('region', region);

      if (count >= 6) return;

      const { data } = await sb
        .from('symbols')
        .insert({ region, symbol: btn.dataset.symbol })
        .select()
        .single();

      if (data) {
        localInsertedSymbols.add(data.id);
        renderSymbol(activeZone, data.symbol, data.id);
      }
    });
  });

  async function loadSymbols() {
    const { data } = await sb.from('symbols').select('*');
    data?.forEach(s => {
      const zone = document.querySelector(`.zone[data-name="${s.region}"]`);
      if (zone) renderSymbol(zone, s.symbol, s.id);
    });
  }

  sb.channel('symbols')
    .on('postgres_changes', { event: 'INSERT', table: 'symbols' }, payload => {
      if (localInsertedSymbols.has(payload.new.id)) {
        localInsertedSymbols.delete(payload.new.id);
        return;
      }
      const zone = document.querySelector(`.zone[data-name="${payload.new.region}"]`);
      if (zone) renderSymbol(zone, payload.new.symbol, payload.new.id);
    })
    .on('postgres_changes', { event: 'DELETE', table: 'symbols' }, payload => {
      document.querySelector(`.symbol[data-id="${payload.old.id}"]`)?.remove();
    })
    .subscribe();

  loadSymbols();

  noteInput.addEventListener('keydown', async e => {
    e.stopPropagation();
    if (e.key !== 'Enter' || !noteInput.value.trim()) return;
    await sb.from('notes').insert({ content: noteInput.value.trim() });
    noteInput.value = '';
  });

  function addNote(n) {
    if ([...notesContainer.children].some(d => d.textContent === n.content)) return;
    const div = document.createElement('div');
    div.textContent = n.content;
    div.onclick = async () => {
      await sb.from('notes').delete().eq('id', n.id);
    };
    notesContainer.appendChild(div);
  }

  async function loadNotes() {
    const { data } = await sb.from('notes').select('*');
    data?.forEach(addNote);
  }

  sb.channel('notes')
    .on('postgres_changes', { event: 'INSERT', table: 'notes' }, payload => addNote(payload.new))
    .on('postgres_changes', { event: 'DELETE', table: 'notes' }, payload => {
      [...notesContainer.children]
        .find(d => d.textContent === payload.old.content)
        ?.remove();
    })
    .subscribe();

  loadNotes();

});
</script>
</body>
</html>
