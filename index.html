<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Cayo Perico Interactive Map</title>

<!-- Favicons (primary: favicon.ico) -->
<link rel="icon" href="favicon.ico" sizes="any">
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
<link rel="manifest" href="site.webmanifest">

<style>
html, body {
  margin:0; padding:0;
  user-select:none;
  overflow:hidden;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background:#111;
}

/* ===== Custom cursor (middle finger) for interactive elements ===== */
:root{
  /* hotspot: 12 2 = where the “click point” is on the SVG (tweak if needed) */
  --hover-cursor: url("https://www.svgrepo.com/show/314118/hand-middle-finger-solid.svg") 12 2, pointer;

  /* ===============================
     HUD COLOR CONTROLS (EDIT HERE)
     (all RGBA)
  ================================ */
  /* Text colors */
  --hud-label-color: rgba(255, 255, 255, 0.95);
  --hud-value-color: rgba(179, 233, 183, 1);
  --hud-subvalue-color: rgba(179, 233, 183, 0.7);

  /* Text glow/shadow colors */
  --hud-label-shadow-color: rgba(0, 0, 0, 0.75);
  --hud-value-shadow-color: rgba(0, 0, 0, 0.90);

  /* Optional HUD panel (kept invisible by default) */
  --hud-bg: rgba(0, 0, 0, 0);
  --hud-border: rgba(255, 255, 255, 0);
  --hud-panel-shadow: rgba(0, 0, 0, 0);

  /* ===============================
     RESPONSIVE UI SCALE (ADDED)
     Keeps HUD + Loot panel sane on 720p/1080p/1440p + 4:3
  ================================ */
  --ui-pad: clamp(6px, 1.0vw, 14px);
  --ui-gap: clamp(8px, 1.2vw, 14px);

  /* Fonts tuned for 720p→1440p */
  --hud-label-size: clamp(18px, 2.0vw, 34px);
  --hud-value-size: clamp(22px, 2.6vw, 48px);
  --hud-subvalue-size: clamp(18px, 2.0vw, 34px);

  /* Loot panel width scaling */
  --panel-width-open: clamp(260px, 22vw, 460px);
  --panel-width-collapsed: clamp(160px, 14vw, 240px);

  /* ===============================
     ZONE SIZE (UPDATED)
     - fixed px size
     - square (1:1)
     - doesn't "responsive scale" with viewport size
     - we also counter browser zoom via --inv-zoom (set by JS)
  ================================ */
  --zone-size: 86px;       /* change this to whatever feels right */
  --inv-zoom: 1;           /* JS updates this */

  /* ===============================
     SYMBOL POP ANIMATION TUNING (ADDED)
  ================================ */
  --symbol-pop-in-duration: 180ms;
  --symbol-pop-out-duration: 140ms;
  --symbol-pop-ease: cubic-bezier(.2, .9, .2, 1.15);
  --symbol-pop-out-ease: cubic-bezier(.4, 0, .2, 1);

  /* ===============================
     HUD ODOMETER ROLL TUNING (ADDED)
  ================================ */
  --hud-roll-duration: 360ms;
  --hud-roll-ease: cubic-bezier(.22,.9,.2,1);
}

/* Apply custom cursor to interactive elements */
a, button, [role="button"],
.zone, .symbol,
#panel button,
#info-header,
.loot-section-header,
#fs-btn,
input, select, textarea {
  cursor: var(--hover-cursor);
}

#map-container {
  position:relative;
  width:100vw;
  height:100vh;
  background:url('compound_map.png') no-repeat center center;
  background-size:cover;
}

/* ===============================
   ZONES (UPDATED)
   - fixed pixel size
   - 1:1 aspect ratio
   - inline width/height % removed from HTML
   - counter zoom using transform: scale(var(--inv-zoom))
=============================== */
.zone {
  position:absolute;
  width: var(--zone-size);
  aspect-ratio: 1 / 1;
  height: auto;

  border:2px solid rgba(30,30,30,0.8);
  background-color: rgba(40,40,40,0.6);
  box-shadow: 0 4px 12px rgba(0,0,0,0.5), 0 0 10px rgba(30,30,30,0.5);
  cursor:pointer;
  box-sizing:border-box;
  border-radius:8px;
  transition: all 0.3s ease;

  /* counteract browser zoom (best-effort via devicePixelRatio) */
  transform: scale(var(--inv-zoom));
  transform-origin: top left;
}
.zone:hover {
  border-color:#fff;
  background-color: rgba(50,50,50,0.6);
  box-shadow: 0 4px 12px rgba(0,0,0,0.5), 0 0 10px rgba(30,30,30,0.5);
}

/* ===============================
   SYMBOLS (UPDATED)
   - 2x2 grid inside zone
   - max 4 symbols per zone
=============================== */
.symbol {
  position:absolute;
  width: 46%;
  aspect-ratio: 1 / 1;
  display:flex;
  justify-content:center;
  align-items:center;
  cursor:pointer;
  border-radius:50%;
  background-color: rgba(255, 255, 255, 0.8);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  transform-origin: center;
  will-change: transform, opacity;
}
.symbol:hover {
  transform: scale(1.2);
  box-shadow: 0 0 10px rgba(255,255,255,0.9);
  background-color: rgba(255, 255, 255, 1);
}

/* =========================================================
   ADDED: Pop-in / pop-out animations for insertable symbols
========================================================= */
@keyframes symbolPopIn {
  0%   { transform: scale(0.75); opacity: 0; filter: blur(0.25px); }
  65%  { transform: scale(1.08); opacity: 1; filter: blur(0); }
  100% { transform: scale(1); opacity: 1; }
}
@keyframes symbolPopOut {
  0%   { transform: scale(1); opacity: 1; }
  100% { transform: scale(0.88); opacity: 0; }
}
.symbol.pop-in {
  animation: symbolPopIn var(--symbol-pop-in-duration) var(--symbol-pop-ease) both;
}
.symbol.pop-out {
  animation: symbolPopOut var(--symbol-pop-out-duration) var(--symbol-pop-out-ease) both;
  pointer-events: none;
}

/* If user prefers reduced motion */
@media (prefers-reduced-motion: reduce) {
  .symbol.pop-in, .symbol.pop-out {
    animation: none !important;
  }
}

/* ===== SYMBOL PANEL ANIMATIONS ===== */
.panel {
  position:absolute;
  background: rgba(40,40,40,0.6);
  color:#fff;
  padding:10px;
  border: 1px solid rgba(40, 40, 40, 0.6);
  border-radius:10px;
  display:none;
  z-index:10;
  min-width:140px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.8), 0 0 20px rgba(30,30,30,0.7);
  transform-origin: top center;
  transition: transform 0.25s cubic-bezier(0.4,0,0.2,1), opacity 0.25s ease;
  transform: scale(0.9);
  opacity:0;
  backdrop-filter: blur(4px);
}

.panel.show {
  display:block;
  transform: scale(1);
  opacity:1;
}

.panel.show-pop {
  animation: popIn 0.25s forwards;
}

@keyframes popIn {
  0% { transform: scale(0.8); opacity:0; }
  60% { transform: scale(1.05); opacity:1; }
  100% { transform: scale(1); }
}

#panel button {
  background: transparent;
  border: 1px solid #888;
  border-radius:6px;
  color:#fff;
  padding:6px 10px;
  margin:4px 2px;
  cursor:pointer;
  transition: all 0.2s ease;
  font-weight:500;
}
#panel button:hover {
  background: #555;
  box-shadow: 0 0 8px #fff;
  transform: translateY(-2px);
}

/* ===== INFO PANEL ===== */
#info-panel {
  position: fixed;
  top: 0;
  left: 0;
  width: var(--panel-width-open);
  background: rgba(40,40,40,0.6);
  border-radius: 8px;
  overflow: hidden;
  z-index: 20;
  color: #fff;
  box-shadow: 0 4px 12px rgba(0,0,0,0.5), 0 0 10px rgba(30,30,30,0.5);
  transition:
    max-height 0.3s ease,
    opacity 0.3s ease,
    width 0.3s ease,
    top 0.3s ease,
    left 0.3s ease;
  max-height: 100vh;
  backdrop-filter: blur(4px);
  max-width: 92vw;
}

#info-panel.collapsed {
  width: var(--panel-width-collapsed);
  top: clamp(10px, 2.5vw, 30px);
  left: clamp(10px, 2.5vw, 30px);
}

#info-header {
  padding: 10px;
  background: rgba(40,40,40,0.6);
  cursor: pointer;
  font-weight: normal;
  transition: background 0.2s ease;
}
#info-header:hover {
  background: rgba(30,30,30,0.7);
}

#info-panel.collapsed #info-content {
  max-height: 0;
  padding: 0 10px;
  opacity: 0;
  overflow: hidden;
  transition: max-height 0.3s ease, opacity 0.3s ease, padding 0.3s ease;
}

#info-content {
  padding: 10px;
  overflow-y: auto;
  max-height: calc(100vh - 50px);
  transition: max-height 0.3s ease, opacity 0.3s ease;
}

#note-input {
  width: calc(100% - 16px);
  padding: 6px 8px;
  margin-top: 6px;
  border-radius: 6px;
  border: 1px solid #555;
  background: rgba(60,60,60,0.8);
  color: #fff;
  outline: none;
  transition: all 0.2s ease;
  box-sizing: border-box;
}
#note-input:focus {
  border-color: #fff;
  background: rgba(60,60,60,1);
  box-shadow: 0 0 6px #fff;
}

.loot-table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 10px;
}
.loot-table th,
.loot-table td {
  border: 1px solid rgba(255,255,255,0.2);
  padding: 4px;
  text-align: center;
}

/* ===== Collapsible Loot Tables ===== */
.loot-section {
  border-radius: 8px;
  margin-bottom: 10px;
  background: rgba(30,30,30,0.25);
  overflow: hidden;
  box-shadow: 0 2px 10px rgba(0,0,0,0.25);
}

.loot-section-header {
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding: 10px;
  cursor: pointer;
  transition: background 0.2s ease;
  background: rgba(40,40,40,0.35);
  border-bottom: 1px solid rgba(255,255,255,0.08);
}
.loot-section-header:hover {
  background: rgba(30,30,30,0.45);
}
.loot-section-title {
  opacity: 0.95;
  font-weight: 600;
}
.loot-section-chevron {
  opacity: 0.9;
  transition: transform 0.25s ease;
  transform: rotate(0deg);
}
.loot-section.collapsed .loot-section-chevron {
  transform: rotate(-90deg);
}

.loot-section-body {
  overflow: hidden;
  max-height: 1200px;
  opacity: 1;
  padding: 8px 0 0 0;
  transition: max-height 0.3s ease, opacity 0.25s ease, padding 0.3s ease;
}
.loot-section.collapsed .loot-section-body {
  max-height: 0;
  opacity: 0;
  padding: 0;
}

/* ===== MISSION SCRIPT FONT ===== */
@font-face {
  font-family: 'Mission Script';
  src: url('Mission-Script.otf') format('opentype');
  font-weight: normal;
  font-style: normal;
}

/* ===== PRICEDOWN FONT ===== */
@font-face {
  font-family: 'Pricedown';
  src: url('pricedown.ttf') format('truetype');
  font-weight: normal;
  font-style: normal;
}

/* Apply to headers */
#panel-title,
#info-header {
  font-family: 'Mission Script', cursive;
  font-size: clamp(20px, 2.2vw, 34px);
}

/* ===== CALCULATOR STYLES ===== */
#calculator {
  background: rgba(50,50,50,0.7);
  padding: 8px;
  margin-top: 10px;
  border-radius: 8px;
  color: #fff;
  font-size: 0.9em;
}
#calculator label {
  margin-right: 4px;
}
#calculator .loot-result {
  margin-top: 6px;
  background: rgba(30,30,30,0.5);
  padding: 4px;
  border-radius: 6px;
}
#calculator select {
  background: rgba(60,60,60,0.8);
  color: #fff;
  border: 1px solid #555;
  border-radius: 4px;
  padding: 2px 4px;
  margin-right: 6px;
  margin-bottom: 6px;
}

/* ===== CALCULATOR UI (minimal + modern) ===== */
#calculator .calc-title {
  margin-top: 10px;
  font-weight: 600;
  opacity: 0.95;
}

#calculator .calc-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin: 6px 0;
  flex-wrap: wrap;
}

#calculator .calc-meta {
  opacity: 0.75;
  font-size: 0.9em;
}

#calculator .calc-input {
  background: rgba(60,60,60,0.8);
  color: #fff;
  border: 1px solid #555;
  border-radius: 6px;
  padding: 4px 8px;
  outline: none;
  transition: all 0.2s ease;
  box-sizing: border-box;
}

#calculator .calc-input:focus {
  border-color: #fff;
  background: rgba(60,60,60,1);
  box-shadow: 0 0 6px #fff;
}

#calculator .calc-btn {
  background: transparent;
  border: 1px solid #888;
  border-radius: 6px;
  color: #fff;
  padding: 4px 10px;
  cursor: pointer;
  transition: all 0.2s ease;
  font-weight: 500;
}
#calculator .calc-btn:hover {
  background: #555;
  box-shadow: 0 0 8px rgba(255,255,255,0.7);
  transform: translateY(-1px);
}
#calculator .calc-btn.danger {
  border-color: rgba(255,255,255,0.35);
  opacity: 0.9;
}

/* ===== Sync indicator (minimal) ===== */
#calculator .sync-line {
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-top: 8px;
  padding-top: 6px;
  border-top: 1px solid rgba(255,255,255,0.12);
}
#calculator .sync-text {
  opacity: 0.75;
  font-size: 0.88em;
  white-space: nowrap;
}
#calculator .sync-dot {
  display:inline-block;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: rgba(255,255,255,0.45);
  margin-right: 6px;
  vertical-align: middle;
}
#calculator .sync-dot.syncing {
  animation: pulse 0.8s infinite ease-in-out;
}
@keyframes pulse {
  0% { transform: scale(0.9); opacity: 0.35; }
  50% { transform: scale(1.15); opacity: 0.95; }
  100% { transform: scale(0.9); opacity: 0.35; }
}

/* ===== Heads-up display (top-right) ===== */
#hud {
  position: fixed;
  top: max(var(--ui-pad), env(safe-area-inset-top));
  right: max(var(--ui-pad), env(safe-area-inset-right));
  z-index: 40;

  background: var(--hud-bg);
  border: 1px solid var(--hud-border);
  box-shadow: 0 0 0 var(--hud-panel-shadow);

  padding: 0;
  pointer-events: none;

  width: max-content;
  max-width: calc(100vw - (max(var(--ui-pad), env(safe-area-inset-right)) * 2));
  overflow: visible;

  transform-origin: top right;
}

.hud-row {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  gap: var(--ui-gap);
  margin: clamp(4px, 0.6vw, 8px) 0;
}

.hud-label {
  font-family: 'Mission Script', cursive;
  font-size: var(--hud-label-size);
  color: var(--hud-label-color);
  opacity: 1;
  text-shadow: 0 0 8px var(--hud-label-shadow-color);
  white-space: nowrap;
}

.hud-value {
  font-family: 'Pricedown', sans-serif;
  font-size: var(--hud-value-size);
  font-weight: bold;
  color: var(--hud-value-color);
  letter-spacing: 1px;
  text-shadow: 0 0 10px var(--hud-value-shadow-color);
  white-space: nowrap;

  display: inline-block;
  transform-origin: 100% 50%;
}

.hud-subvalue {
  font-family: 'Pricedown', sans-serif;
  font-size: var(--hud-subvalue-size);
  color: var(--hud-subvalue-color);
  opacity: 1;
  text-shadow: 0 0 10px var(--hud-value-shadow-color);
  white-space: nowrap;

  display: inline-block;
  transform-origin: 100% 50%;
}

/* =========================================================
   ADDED: Odometer / rolling digit HUD animation
========================================================= */
.roll-number {
  display: inline-flex;
  align-items: baseline;
  justify-content: flex-end;
  white-space: nowrap;
}

.roll-char {
  display: inline-block;
}

.roll-digit {
  display: inline-block;
  position: relative;
  overflow: hidden;
  height: 1em;
  line-height: 1em;
  width: 0.62em;
  vertical-align: baseline;
}

.roll-digit-inner {
  display: block;
  will-change: transform;
  transform: translateY(0);
  transition: transform var(--hud-roll-duration) var(--hud-roll-ease);
}

.roll-digit,
.roll-static {
  text-shadow:
    0 0 2px rgba(0,0,0,0.9),
    0 0 4px rgba(0,0,0,0.6);
}

.roll-digit-inner > span {
  display: block;
  height: 1em;
  line-height: 1em;
  text-align: center;
}

.roll-static {
  display: inline-block;
  vertical-align: baseline;
}

@media (prefers-reduced-motion: reduce) {
  .roll-digit-inner {
    transition: none !important;
  }
}

/* =========================================================
   ADDED: Shared tooltip style
========================================================= */
.tooltip {
  position: fixed;
  z-index: 1000;
  pointer-events: none;
  background: rgba(40,40,40,0.75);
  color: #fff;
  border: 1px solid rgba(255,255,255,0.18);
  box-shadow: 0 4px 12px rgba(0,0,0,0.5), 0 0 10px rgba(30,30,30,0.35);
  padding: 8px 10px;
  border-radius: 10px;
  font-size: 13px;
  backdrop-filter: blur(4px);
  opacity: 0;
  transform: translateY(2px) scale(0.98);
  transition: opacity 0.15s ease, transform 0.15s ease;
  white-space: nowrap;
  font-family: 'Mission Script', cursive;
  font-size: clamp(16px, 1.6vw, 24px);
  line-height: 1.05;
  letter-spacing: 0.4px;
  padding: 10px 12px;
}
.tooltip.show {
  opacity: 1;
  transform: translateY(0) scale(1);
}

/* =========================================================
   ADDED: Floating fullscreen button
========================================================= */
#fs-btn {
  position: fixed;
  right: max(var(--ui-pad), env(safe-area-inset-right));
  bottom: max(var(--ui-pad), env(safe-area-inset-bottom));
  z-index: 60;

  width: 54px;
  height: 54px;
  border-radius: 999px;
  cursor: pointer;

  border: 1px solid rgba(255,255,255,0.22);
  background: rgba(40,40,40,0.55);
  box-shadow: 0 4px 12px rgba(0,0,0,0.5), 0 0 10px rgba(30,30,30,0.35);
  backdrop-filter: blur(4px);

  display: flex;
  align-items: center;
  justify-content: center;

  transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease, border-color 0.2s ease;
}
#fs-btn:hover {
  transform: translateY(-2px);
  border-color: rgba(255,255,255,0.6);
  background: rgba(50,50,50,0.65);
  box-shadow: 0 6px 16px rgba(0,0,0,0.55), 0 0 12px rgba(255,255,255,0.15);
}
#fs-btn:active {
  transform: translateY(0);
}
#fs-btn svg {
  width: 26px;
  height: 26px;
  opacity: 0.95;
  fill: none;
  stroke: rgba(255,255,255,0.92);
  stroke-width: 2;
  stroke-linecap: round;
  stroke-linejoin: round;
}

/* =========================================================
   ADDED: Toast popup (Supabase failure)
========================================================= */
#toast {
  position: fixed;
  left: 50%;
  bottom: max(16px, env(safe-area-inset-bottom));
  transform: translateX(-50%) translateY(10px);
  z-index: 9999;

  min-width: 260px;
  max-width: min(520px, calc(100vw - 24px));

  background: rgba(20,20,20,0.92);
  color: #fff;
  border: 1px solid rgba(255,255,255,0.18);
  border-radius: 14px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.6);
  backdrop-filter: blur(6px);

  padding: 12px 14px;
  display: grid;
  grid-template-columns: 1fr auto;
  gap: 10px;
  align-items: center;

  opacity: 0;
  pointer-events: none;
  transition: opacity 160ms ease, transform 160ms ease;
}
#toast.show {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
  pointer-events: auto;
}
#toast .toast-title {
  font-weight: 700;
  margin-bottom: 2px;
  opacity: 0.95;
}
#toast .toast-msg {
  opacity: 0.9;
  font-size: 0.95em;
  line-height: 1.25;
}
#toast button {
  background: transparent;
  border: 1px solid rgba(255,255,255,0.28);
  color: #fff;
  border-radius: 10px;
  padding: 6px 10px;
  cursor: pointer;
}
#toast button:hover {
  background: rgba(255,255,255,0.12);
}
</style>
</head>

<body>

<div id="hud">
  <div class="hud-row">
    <span class="hud-label">Total Take:</span>
    <span class="hud-value" id="hud-total">$0</span>
  </div>
  <div class="hud-divider"></div>
  <div id="hud-players"></div>
</div>

<div id="info-panel" class="collapsed">
  <div id="info-header">Loot Panel ▼</div>
  <div id="info-content">

    <!-- default collapsed -->
    <div class="loot-section collapsed" data-section="primary">
      <div class="loot-section-header">
        <div class="loot-section-title">Primary Loot Table</div>
        <div class="loot-section-chevron">▼</div>
      </div>
      <div class="loot-section-body">
        <table class="loot-table">
          <tr><th>Primary Loot</th><th>Normal</th><th>Hard</th><td>Rarity &lt;72H</td><td>Rarity &gt;72H</td></tr>
          <tr><td>Tequila</td><td>$630k</td><td>$693k</td><td>47.6%</td><td>25%</td></tr>
          <tr><td>Ruby</td><td>$700k</td><td>$770k</td><td>19%</td><td>25%</td></tr>
          <tr><td>Bonds</td><td>$770k</td><td>$847k</td><td>28.6%</td><td>37.5%</td></tr>
          <tr><td>Diamond</td><td>$1.3mil</td><td>$1.43mil</td><td>4.8%</td><td>12.5%</td></tr>
          <tr><td>Panther</td><td>$1.9mil</td><td>$2.09mil</td><td>Events</td><td>Events</td></tr>
        </table>
      </div>
    </div>

    <!-- default collapsed -->
    <div class="loot-section collapsed" data-section="secondary">
      <div class="loot-section-header">
        <div class="loot-section-title">Secondary Loot Table</div>
        <div class="loot-section-chevron">▼</div>
      </div>
      <div class="loot-section-body">
        <table class="loot-table">
          <tr><th>Secondary Loot</th><th>Bag %</th><th>Value Stack</th></tr>
          <tr><td>Wall Safe</td><td>0%</td><td>$20k–$99k</td></tr>
          <tr><td>Cash</td><td>25%</td><td>$78k–$89k</td></tr>
          <tr><td>Painting</td><td>50%</td><td>$176k–$199k</td></tr>
          <tr><td>Gold</td><td>66.7%</td><td>$328k–$333k</td></tr>
        </table>
      </div>
    </div>

    <!-- default collapsed -->
    <div class="loot-section collapsed" data-section="fee">
      <div class="loot-section-header">
        <div class="loot-section-title">Fee Table</div>
        <div class="loot-section-chevron">▼</div>
      </div>
      <div class="loot-section-body">
        <table class="loot-table">
          <tr><th>Fee</th><th>Cut %</th></tr>
          <tr><td>Pavel Cut</td><td>2%</td></tr>
          <tr><td>Fencing Fee</td><td>10%</td></tr>
        </table>
      </div>
    </div>

    <div id="calculator">
      <div>
        <label>Difficulty:</label>
        <select id="difficulty-select">
          <option value="normal">Normal</option>
          <option value="hard">Hard</option>
        </select>
      </div>

      <div>
        <label>Primary Loot:</label>
        <select id="primary-loot-select">
          <option value="">-- Select --</option>
          <option value="Tequila">Tequila</option>
          <option value="Ruby">Ruby</option>
          <option value="Bonds">Bonds</option>
          <option value="Diamond">Diamond</option>
          <option value="Panther">Panther</option>
        </select>
      </div>

      <div id="player-cuts"></div>

      <div id="secondary-loot"></div>
      <div class="loot-result" id="bag-status"></div>

      <div class="loot-result" id="loot-result"></div>

      <div class="sync-line">
        <div class="sync-text">
          <span class="sync-dot" id="sync-dot"></span><span id="sync-text">Synced</span>
        </div>
        <div class="sync-text">
          <span class="sync-dot" id="sync-dot-map"></span><span id="sync-text-map">Map synced</span>
        </div>
      </div>
    </div>

    <div id="notes-container"></div>
    <input id="note-input" placeholder="Add a note...">
  </div>
</div>

<div id="map-container">
  <div class="zone" style="left:50%;top:50%;" data-name="Office"></div>
  <div class="zone" style="left:45%;top:48%;" data-name="Vault"></div>
  <div class="zone" style="left:54%;top:45%;" data-name="North Storage"></div>
  <div class="zone" style="left:67%;top:55%;" data-name="West Storage"></div>
  <div class="zone" style="left:48%;top:67%;" data-name="South Storage"></div>
</div>

<div id="panel" class="panel">
  <h3 id="panel-title"></h3>
  <button data-symbol="Gold">Gold</button>
  <button data-symbol="Cash">Cash</button>
  <button data-symbol="Painting">Painting</button>
</div>

<button id="fs-btn" type="button" aria-label="Toggle Fullscreen Mode">
  <svg viewBox="0 0 24 24" aria-hidden="true">
    <path d="M8 3H5a2 2 0 0 0-2 2v3M16 3h3a2 2 0 0 1 2 2v3M8 21H5a2 2 0 0 1-2-2v-3M16 21h3a2 2 0 0 0 2-2v-3"/>
  </svg>
</button>
<div id="ui-tooltip" class="tooltip" role="tooltip"></div>

<div id="toast" role="status" aria-live="polite">
  <div>
    <div class="toast-title" id="toast-title">Error</div>
    <div class="toast-msg" id="toast-msg">Something went wrong.</div>
  </div>
  <button type="button" id="toast-close">Close</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  function updateInvZoom() {
    const dpr = window.devicePixelRatio || 1;
    document.documentElement.style.setProperty('--inv-zoom', String(1 / dpr));
  }
  updateInvZoom();
  window.addEventListener('resize', updateInvZoom);
  if (window.visualViewport) {
    window.visualViewport.addEventListener('resize', updateInvZoom);
    window.visualViewport.addEventListener('scroll', updateInvZoom);
  }

  const toastEl = document.getElementById('toast');
  const toastTitleEl = document.getElementById('toast-title');
  const toastMsgEl = document.getElementById('toast-msg');
  const toastCloseBtn = document.getElementById('toast-close');
  let toastTimer = null;

  function showToast(title, message, ms = 3500) {
    if (!toastEl) return;
    toastTitleEl.textContent = title || 'Notice';
    toastMsgEl.textContent = message || '';
    toastEl.classList.add('show');

    if (toastTimer) clearTimeout(toastTimer);
    toastTimer = setTimeout(() => toastEl.classList.remove('show'), ms);
  }

  toastCloseBtn?.addEventListener('click', () => {
    toastEl?.classList.remove('show');
  });

  const sb = supabase.createClient(
    'https://qanrnafvvnmimewtxrxv.supabase.co',
    'sb_publishable_8F3cI7ZKCgpxv6UfaRJn7A_r1s17TmC'
  );

  const zones = document.querySelectorAll('.zone');
  const panel = document.getElementById('panel');
  const panelTitle = document.getElementById('panel-title');
  const infoPanel = document.getElementById('info-panel');
  const infoHeader = document.getElementById('info-header');
  const notesContainer = document.getElementById('notes-container');
  const noteInput = document.getElementById('note-input');

  const hudTotal = document.getElementById('hud-total');
  const hudPlayers = document.getElementById('hud-players');

  let activeZone = null;
  let collapsed = false;
  const localInsertedSymbols = new Set();
  let calculatorState = null;
  let symbolsLoaded = false;
  let calculatorLoaded = false;

  function recomputeIfReady() {
    if (!symbolsLoaded || !calculatorLoaded) return;
    renderSecondaryControls();
    renderLootResult();
  }

  function playPopIn(el) {
    if (!el) return;
    el.classList.remove('pop-in');
    void el.offsetWidth;
    el.classList.add('pop-in');
    el.addEventListener('animationend', () => {
      el.classList.remove('pop-in');
    }, { once: true });
  }

  function popOutAndRemove(el) {
    if (!el) return;
    if (el.dataset.removing === '1') return;
    el.dataset.removing = '1';

    el.classList.remove('pop-in');
    el.classList.add('pop-out');
    el.addEventListener('animationend', () => {
      el.remove();
    }, { once: true });
  }

  function popOutSymbolById(id) {
    const el = document.querySelector(\`.symbol[data-id="\${id}"]\`);
    if (el) popOutAndRemove(el);
  }

  const tooltip = document.getElementById('ui-tooltip');
  let tooltipTarget = null;

  function showTooltipFor(el, text) {
    if (!tooltip) return;
    tooltipTarget = el;
    tooltip.textContent = text;
    tooltip.classList.add('show');
    positionTooltip();
  }

  function hideTooltip() {
    if (!tooltip) return;
    tooltipTarget = null;
    tooltip.classList.remove('show');
  }

  function positionTooltip() {
    if (!tooltipTarget || !tooltip.classList.contains('show')) return;

    const margin = 12;
    const r = tooltipTarget.getBoundingClientRect();
    let x = r.left + (r.width / 2);
    let y = r.top - margin;

    const tw = tooltip.offsetWidth;
    const th = tooltip.offsetHeight;

    let left = x - (tw / 2);
    let top = y - th;

    const vw = window.innerWidth;
    const vh = window.innerHeight;

    left = Math.max(8, Math.min(vw - tw - 8, left));
    top = Math.max(8, Math.min(vh - th - 8, top));

    tooltip.style.left = left + 'px';
    tooltip.style.top = top + 'px';
  }

  window.addEventListener('resize', positionTooltip);
  document.addEventListener('scroll', positionTooltip, true);

  zones.forEach(zone => {
    zone.addEventListener('mouseenter', () => {
      showTooltipFor(zone, zone.dataset.name || 'Zone');
    });
    zone.addEventListener('mouseleave', hideTooltip);
  });

  const fsBtn = document.getElementById('fs-btn');

  function isFullscreen() {
    return !!document.fullscreenElement;
  }

  function setFsIcon() {
    if (!fsBtn) return;
    fsBtn.innerHTML = isFullscreen()
      ? \`<svg viewBox="0 0 24 24" aria-hidden="true">
           <path d="M9 3H5a2 2 0 0 0-2 2v4M15 3h4a2 2 0 0 1 2 2v4M9 21H5a2 2 0 0 1-2-2v-4M15 21h4a2 2 0 0 0 2-2v-4"/>
           <path d="M9 9H7V7M15 9h2V7M9 15H7v2M15 15h2v2"/>
         </svg>\`
      : \`<svg viewBox="0 0 24 24" aria-hidden="true">
           <path d="M8 3H5a2 2 0 0 0-2 2v3M16 3h3a2 2 0 0 1 2 2v3M8 21H5a2 2 0 0 1-2-2v-3M16 21h3a2 2 0 0 0 2-2v-3"/>
           <path d="M9 9V5H5M15 9V5h4M9 15v4H5M15 15v4h4"/>
         </svg>\`;
  }

  async function toggleFullscreen() {
    try {
      if (!isFullscreen()) {
        await document.documentElement.requestFullscreen();
      } else {
        await document.exitFullscreen();
      }
    } catch (err) {
      console.warn('Fullscreen toggle failed:', err);
      showToast('Fullscreen failed', 'Your browser blocked fullscreen. Try again.');
    }
    setFsIcon();
    positionTooltip();
  }

  if (fsBtn) {
    fsBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      toggleFullscreen();
    });

    fsBtn.addEventListener('mouseenter', () => {
      showTooltipFor(fsBtn, 'Toggle Fullscreen Mode');
    });
    fsBtn.addEventListener('mouseleave', hideTooltip);

    document.addEventListener('fullscreenchange', () => {
      setFsIcon();
      positionTooltip();
    });

    setFsIcon();
  }

  function initLootSections() {
    document.querySelectorAll('.loot-section').forEach(section => {
      const header = section.querySelector('.loot-section-header');
      const chevron = section.querySelector('.loot-section-chevron');
      if (!header || !chevron) return;

      section.classList.add('collapsed');

      header.addEventListener('click', (e) => {
        e.stopPropagation();
        section.classList.toggle('collapsed');
        chevron.textContent = '▼';
      });
    });
  }
  initLootSections();

  /* ================= NOTES LOGIC ================= */
  noteInput.addEventListener('keydown', async e => {
    e.stopPropagation();
    if (e.key !== 'Enter' || !noteInput.value.trim()) return;

    const { error } = await sb.from('notes').insert({ content: noteInput.value.trim() });
    if (error) {
      showToast('Sync failed', 'Could not save note. Check your connection and try again.');
      return;
    }
    noteInput.value = '';
  });

  function addNote(n) {
    if (notesContainer.querySelector(\`[data-id="\${n.id}"]\`)) return;
    const div = document.createElement('div');
    div.textContent = n.content;
    div.dataset.id = n.id;
    div.onclick = async () => {
      const { error } = await sb.from('notes').delete().eq('id', n.id);
      if (error) showToast('Sync failed', 'Could not delete note. Try again.');
    };
    notesContainer.appendChild(div);
  }

  async function loadNotes() {
    const { data, error } = await sb.from('notes').select('*');
    if (error) showToast('Load failed', 'Could not load notes. Try refreshing.');
    data?.forEach(addNote);
  }

  sb.channel('notes')
    .on('postgres_changes', { event: 'INSERT', table: 'notes' }, payload => addNote(payload.new))
    .on('postgres_changes', { event: 'DELETE', table: 'notes' }, payload => {
      notesContainer.querySelector(\`[data-id="\${payload.old.id}"]\`)?.remove();
    })
    .subscribe();

  loadNotes();

  /* ================= SYMBOLS LOGIC ================= */
  zones.forEach(zone => {
    zone.addEventListener('click', e => {
      e.stopPropagation();
      activeZone = zone;
      panelTitle.textContent = zone.dataset.name;
      const r = zone.getBoundingClientRect();
      panel.style.left = r.left + 'px';
      panel.style.top = (r.bottom + 10) + 'px';

      panel.classList.remove('show', 'show-pop');
      panel.style.display = 'block';
      requestAnimationFrame(() => {
        panel.classList.add('show-pop');
        panel.classList.add('show');
      });
    });
  });

  document.addEventListener('click', e => {
    if (panel.contains(e.target) || infoPanel.contains(e.target)) return;
    panel.classList.remove('show-pop', 'show');
    setTimeout(() => { panel.style.display = 'none'; }, 250);
    activeZone = null;
  });

  infoHeader.addEventListener('click', e => {
    e.stopPropagation();
    collapsed = !collapsed;
    infoPanel.classList.toggle('collapsed', collapsed);
    infoHeader.innerHTML = collapsed ? 'Loot Panel ▼' : 'Loot Panel ▲';
  });

  function renderSymbol(zone, type, id) {
    if (zone.querySelector(\`.symbol[data-id="\${id}"]\`)) return;

    const idx = zone.querySelectorAll('.symbol').length;
    if (idx >= 4) return;

    const symbol = document.createElement('div');
    symbol.className = 'symbol';
    symbol.dataset.id = id;

    const row = Math.floor(idx / 2);
    const col = idx % 2;
    symbol.style.top = \`\${row * 50 + 2}%\`;
    symbol.style.left = \`\${col * 50 + 2}%\`;

    const icons = {
      Gold: 'https://www.svgrepo.com/show/532436/gold.svg',
      Cash: 'https://www.svgrepo.com/show/175801/dollar-exchange.svg',
      Painting: 'https://www.svgrepo.com/show/535548/painting.svg'
    };
    symbol.innerHTML = \`<img src="\${icons[type]}" width="100%" height="100%">\`;

    playPopIn(symbol);

    symbol.onclick = async e => {
      e.stopPropagation();
      popOutAndRemove(symbol);

      const { error } = await sb.from('symbols').delete().eq('id', id);
      if (error) {
        showToast('Sync failed', 'Could not delete symbol. Check connection and try again.');
        renderSymbol(zone, type, id);
      }
    };

    zone.appendChild(symbol);
  }

  panel.querySelectorAll('button').forEach(btn => {
    btn.addEventListener('click', async e => {
      e.stopPropagation();
      if (!activeZone) return;

      const region = activeZone.dataset.name;

      const { count, error: countErr } = await sb.from('symbols')
        .select('*', { count: 'exact', head: true })
        .eq('region', region);

      if (countErr) {
        showToast('Sync failed', 'Could not check zone capacity. Try again.');
        return;
      }
      if (count >= 4) return;

      const { data, error } = await sb.from('symbols')
        .insert({ region, symbol: btn.dataset.symbol })
        .select()
        .single();

      if (error) {
        showToast('Sync failed', 'Could not add symbol. Check connection and try again.');
        return;
      }

      if (data) {
        localInsertedSymbols.add(data.id);
        renderSymbol(activeZone, data.symbol, data.id);
      }
    });
  });

  async function loadSymbols() {
    const { data, error } = await sb.from('symbols').select('*');
    if (error) {
      showToast('Load failed', 'Could not load symbols. Try refreshing.');
    }
    data?.forEach(s => {
      const zone = document.querySelector(\`.zone[data-name="\${s.region}"]\`);
      if (zone) renderSymbol(zone, s.symbol, s.id);
    });

    symbolsLoaded = true;
    recomputeIfReady();
  }

  /* ===== SYNC INDICATORS ===== */
  const syncDot = document.getElementById('sync-dot');
  const syncText = document.getElementById('sync-text');
  const syncDotMap = document.getElementById('sync-dot-map');
  const syncTextMap = document.getElementById('sync-text-map');

  function setSyncing(on) {
    if (on) {
      syncDot.classList.add('syncing');
      syncText.textContent = 'Syncing...';
    } else {
      syncDot.classList.remove('syncing');
      syncText.textContent = 'Synced';
    }
  }

  function setMapSyncing(on) {
    if (on) {
      syncDotMap.classList.add('syncing');
      syncTextMap.textContent = 'Map syncing...';
    } else {
      syncDotMap.classList.remove('syncing');
      syncTextMap.textContent = 'Map synced';
    }
  }

  function isCalculatorEditing() {
    const el = document.activeElement;
    if (!el) return false;
    return !!el.closest('#calculator') && (el.tagName === 'INPUT' || el.tagName === 'SELECT' || el.isContentEditable);
  }

  // ✅ FIXED: single clean realtime handler (no duplicate orphan code)
  sb.channel('symbols')
    .on('postgres_changes', { event: 'INSERT', table: 'symbols' }, payload => {
      setMapSyncing(true);

      if (localInsertedSymbols.has(payload.new.id)) {
        localInsertedSymbols.delete(payload.new.id);

        // ✅ update calculator immediately for local inserts
        if (calculatorState) {
          renderSecondaryControls();
          renderLootResult();
        }

        setMapSyncing(false);
        return;
      }

      const zone = document.querySelector(\`.zone[data-name="\${payload.new.region}"]\`);
      if (zone) renderSymbol(zone, payload.new.symbol, payload.new.id);

      if (calculatorState) {
        renderSecondaryControls();
        renderLootResult();
      }

      setMapSyncing(false);
    })
    .on('postgres_changes', { event: 'DELETE', table: 'symbols' }, payload => {
      setMapSyncing(true);

      popOutSymbolById(payload.old.id);

      if (calculatorState) {
        renderSecondaryControls();
        renderLootResult();
      }

      setMapSyncing(false);
    })
    .subscribe();

  loadCalculator();

  /* ================= CALCULATOR LOGIC ================= */
  const difficultySelect = document.getElementById('difficulty-select');
  const primaryLootSelect = document.getElementById('primary-loot-select');
  const playerCutsDiv = document.getElementById('player-cuts');
  const lootResultDiv = document.getElementById('loot-result');
  const secondaryLootDiv = document.getElementById('secondary-loot');
  const bagStatusDiv = document.getElementById('bag-status');

  // Deterministic bag math in "bag units"
  // 1 bag = 3000 units (each unit = 1/30%)
  // This represents 2/3 exactly: Gold stack = 2000 units.
  const BAG_UNITS_PER_BAG = 3000;
  const BAG_PER_STACK_UNITS = { Cash: 750, Painting: 1500, Gold: 2000 };

  const WALL_SAFE_MIN = 20000;
  const WALL_SAFE_MAX = 99000;

  const primaryValues = {
    normal: {Tequila:630000, Ruby:700000, Bonds:770000, Diamond:1300000, Panther:1900000},
    hard:   {Tequila:693000, Ruby:770000, Bonds:847000, Diamond:1430000, Panther:2090000}
  };

  const secondaryRanges = {
    Cash:[78000,89000],
    Painting:[176000,199000],
    Gold:[328000,333000]
  };

  function getPlayerCountForBag() {
    const n = (calculatorState?.players || []).length;
    return Math.max(1, n);
  }

  function getBagCapacityUnits() {
    return getPlayerCountForBag() * BAG_UNITS_PER_BAG;
  }

  async function loadCalculator() {
    const { data, error } = await sb.from('calculator_state').select('*').limit(1).maybeSingle();
    if (error) {
      showToast('Load failed', 'Could not load calculator state. Try refreshing.');
      return;
    }
    if (!data) return;

    calculatorState = data;
    calculatorState.players = calculatorState.players || [];
    calculatorState.secondary_take = calculatorState.secondary_take || { Cash: 0, Painting: 0, Gold: 0 };
    if (calculatorState.secondary_take.Cash == null) calculatorState.secondary_take.Cash = 0;
    if (calculatorState.secondary_take.Gold == null) calculatorState.secondary_take.Gold = 0;
    if (calculatorState.secondary_take.Painting == null) calculatorState.secondary_take.Painting = 0;

    difficultySelect.value = calculatorState.difficulty || 'normal';
    primaryLootSelect.value = calculatorState.primary_loot || '';

    renderPlayers();
    calculatorLoaded = true;
    recomputeIfReady();
  }

  async function updateCalculatorState(updates) {
    setSyncing(true);

    const { data, error } = await sb
      .from('calculator_state')
      .update(updates)
      .eq('id', calculatorState.id)
      .select()
      .single();

    if (error) {
      console.error('calculator_state update failed:', error);
      setSyncing(false);
      showToast('Sync failed', `${error.message}${error.details ? ' — ' + error.details : ''}`);
      return;
    }

    calculatorState = data;
    setSyncing(false);
  }

  function enforceCutLimit() {
    const totalCut = calculatorState.players.reduce((sum,p)=>sum+(parseFloat(p.cut)||0),0);
    if (totalCut > 300 && totalCut > 0) {
      const ratio = 300 / totalCut;
      calculatorState.players.forEach(p => p.cut = Math.floor((parseFloat(p.cut)||0) * ratio));
    }
  }

  function parseIntOnly(str) {
    const cleaned = String(str ?? '').replace(/[^0-9]/g, '');
    if (cleaned === '') return 0;
    const n = parseInt(cleaned, 10);
    return Number.isFinite(n) ? n : 0;
  }

  function parseDecimalInput(str) {
    if (str == null) return 0;
    const cleaned = String(str)
      .trim()
      .replace(',', '.')
      .replace(/[^0-9.]/g, '');
    if (cleaned === '' || cleaned === '.') return 0;
    const n = parseFloat(cleaned);
    return Number.isFinite(n) ? n : 0;
  }

  async function commitPlayerName(idx, raw) {
    const v = String(raw ?? '').trim();
    calculatorState.players[idx].name = v;
    await updateCalculatorState({ players: calculatorState.players });
    renderLootResult();
  }

  async function commitPlayerCut(idx, raw) {
    let v = parseIntOnly(raw);
    v = Math.min(100, Math.max(0, v));

    calculatorState.players[idx].cut = v;
    enforceCutLimit();

    await updateCalculatorState({ players: calculatorState.players });
    renderPlayers();
    renderLootResult();
  }

  function renderPlayers() {
    playerCutsDiv.innerHTML = '';

    (calculatorState.players || []).forEach((p, idx) => {
      const row = document.createElement('div');
      row.className = 'calc-row';

      row.innerHTML = `
        <span class="calc-meta">Player ${idx+1}</span>
        <input class="calc-input player-name" type="text" value="${(p.name ?? '')}" data-idx="${idx}"
               style="min-width:120px; flex: 1;">
        <span class="calc-meta">Cut %</span>
        <input class="calc-input player-cut" type="text" inputmode="numeric" autocomplete="off" spellcheck="false"
               value="${(p.cut ?? 0)}" data-idx="${idx}" style="width:80px;">
        <button class="calc-btn danger remove-player" data-idx="${idx}">Remove</button>
        <span class="calc-meta">(Enter to sync)</span>
      `;
      playerCutsDiv.appendChild(row);
    });

    if ((calculatorState.players || []).length < 3) {
      const addRow = document.createElement('div');
      addRow.className = 'calc-row';

      const btn = document.createElement('button');
      btn.className = 'calc-btn';
      btn.textContent = 'Add Player';
      btn.onclick = async (e) => {
        e.stopPropagation();
        calculatorState.players.push({name:'Player ' + (calculatorState.players.length+1), cut: 0});
        enforceCutLimit();
        await updateCalculatorState({players: calculatorState.players});
        renderPlayers();
        renderLootResult();
      };

      addRow.appendChild(btn);
      playerCutsDiv.appendChild(addRow);
    }

    playerCutsDiv.querySelectorAll('.player-name').forEach(inp => {
      inp.addEventListener('keydown', async e => {
        e.stopPropagation();
        if (e.key !== 'Enter') return;
        const idx = parseInt(e.target.dataset.idx, 10);
        await commitPlayerName(idx, e.target.value);
      });
      inp.addEventListener('blur', async e => {
        const idx = parseInt(e.target.dataset.idx, 10);
        await commitPlayerName(idx, e.target.value);
      });
    });

    playerCutsDiv.querySelectorAll('.player-cut').forEach(inp => {
      inp.addEventListener('keydown', async e => {
        e.stopPropagation();
        if (e.key !== 'Enter') return;
        const idx = parseInt(e.target.dataset.idx, 10);
        await commitPlayerCut(idx, e.target.value);
      });
      inp.addEventListener('blur', async e => {
        const idx = parseInt(e.target.dataset.idx, 10);
        await commitPlayerCut(idx, e.target.value);
      });
    });

    playerCutsDiv.querySelectorAll('.remove-player').forEach(btn => {
      btn.addEventListener('click', async e => {
        e.stopPropagation();
        const idx = parseInt(btn.dataset.idx, 10);
        calculatorState.players.splice(idx,1);
        enforceCutLimit();
        await updateCalculatorState({players: calculatorState.players});
        renderPlayers();
        renderLootResult();
      });
    });
  }

  difficultySelect.addEventListener('change', async e => {
    e.stopPropagation();
    calculatorState.difficulty = e.target.value;
    await updateCalculatorState({difficulty: e.target.value});
    renderLootResult();
  });

  primaryLootSelect.addEventListener('change', async e => {
    e.stopPropagation();
    calculatorState.primary_loot = e.target.value;
    await updateCalculatorState({primary_loot: e.target.value});
    renderLootResult();
  });

  function getSymbolCounts() {
    const counts = { Cash:0, Painting:0, Gold:0 };
    document.querySelectorAll('.symbol').forEach(s => {
      const img = s.querySelector('img')?.src.toLowerCase();
      if (img?.includes('dollar')) counts.Cash++;
      if (img?.includes('painting')) counts.Painting++;
      if (img?.includes('gold')) counts.Gold++;
    });
    return counts;
  }

  function clampSecondaryToAvailable() {
    const available = getSymbolCounts();
    const take = calculatorState.secondary_take || { Cash:0, Painting:0, Gold:0 };

    take.Cash = Math.max(0, Math.min(available.Cash, parseFloat(take.Cash)||0));
    take.Gold = Math.max(0, Math.min(available.Gold, parseFloat(take.Gold)||0));
    take.Painting = Math.max(0, Math.min(available.Painting, Math.floor(parseFloat(take.Painting)||0)));

    calculatorState.secondary_take = take;
  }

  function computeBagUsedUnits(take) {
    const cashT = Math.round((parseFloat(take.Cash) || 0) * 10);     // tenths
    const goldT = Math.round((parseFloat(take.Gold) || 0) * 10);     // tenths
    const painting = Math.floor(parseFloat(take.Painting) || 0);     // whole

    const used =
      cashT * (BAG_PER_STACK_UNITS.Cash / 10) +
      goldT * (BAG_PER_STACK_UNITS.Gold / 10) +
      painting * BAG_PER_STACK_UNITS.Painting;

    return Math.max(0, Math.round(used));
  }

  function enforceBagCapacity(changedType) {
    const take = calculatorState.secondary_take || { Cash:0, Painting:0, Gold:0 };
    const BAG_CAPACITY_UNITS = getBagCapacityUnits();

    let usedUnits = computeBagUsedUnits(take);
    if (usedUnits <= BAG_CAPACITY_UNITS) return;

    const perUnits = BAG_PER_STACK_UNITS[changedType];
    if (!perUnits) return;

    const excessUnits = usedUnits - BAG_CAPACITY_UNITS;
    let reduceBy = excessUnits / perUnits;

    let cur = parseFloat(take[changedType]) || 0;
    let next = cur - reduceBy;

    if (changedType === 'Painting') {
      next = Math.floor(next);
    } else {
      next = Math.max(0, Math.round(next * 10) / 10);
    }

    take[changedType] = Math.max(0, next);
    calculatorState.secondary_take = take;
  }

  function computeSuggestedSecondaryTake() {
    const available = getSymbolCounts();
    const capacityUnits = getBagCapacityUnits();

    const MIN_VALUE = { Cash: 78000, Painting: 176000, Gold: 328000 };

    const maxPaint = Math.max(0, Math.floor(available.Painting || 0));
    const maxGoldT = Math.max(0, Math.floor((available.Gold || 0) * 10));
    const maxCashT = Math.max(0, Math.floor((available.Cash || 0) * 10));

    let best = { Cash: 0, Painting: 0, Gold: 0 };
    let bestValue = -1;
    let bestUsed = -1;

    function scoreMinValue(take) {
      return (take.Cash || 0) * MIN_VALUE.Cash +
             (take.Gold || 0) * MIN_VALUE.Gold +
             (take.Painting || 0) * MIN_VALUE.Painting;
    }

    function isBetter(candidate, candidateValue, candidateUsed) {
      if (candidateValue > bestValue) return true;
      if (candidateValue < bestValue) return false;

      if (candidateUsed > bestUsed) return true;
      if (candidateUsed < bestUsed) return false;

      if ((candidate.Gold || 0) > (best.Gold || 0)) return true;
      if ((candidate.Gold || 0) < (best.Gold || 0)) return false;

      if ((candidate.Painting || 0) > (best.Painting || 0)) return true;
      if ((candidate.Painting || 0) < (best.Painting || 0)) return false;

      return false;
    }

    for (let p = 0; p <= maxPaint; p++) {
      for (let gT = 0; gT <= maxGoldT; gT++) {
        const g = gT / 10;

        const baseTake = { Cash: 0, Painting: p, Gold: g };
        const baseUsed = computeBagUsedUnits(baseTake);
        if (baseUsed > capacityUnits) continue;

        for (let cT = 0; cT <= maxCashT; cT++) {
          const c = cT / 10;

          const take = { Cash: c, Painting: p, Gold: g };
          const used = computeBagUsedUnits(take);
          if (used > capacityUnits) continue;

          const value = scoreMinValue(take);

          if (isBetter(take, value, used)) {
            best = take;
            bestValue = value;
            bestUsed = used;
          }
        }
      }
    }

    best.Cash = Math.round((best.Cash || 0) * 10) / 10;
    best.Gold = Math.round((best.Gold || 0) * 10) / 10;
    best.Painting = Math.floor(best.Painting || 0);

    return best;
  }

  function renderSecondaryControls() {
    if (!calculatorState) return;

    clampSecondaryToAvailable();

    const available = getSymbolCounts();
    const take = calculatorState.secondary_take || { Cash:0, Painting:0, Gold:0 };

    const suggested = computeSuggestedSecondaryTake();
    const suggestedUsedPct = computeBagUsedUnits(suggested) / 30;
    const capPct = getBagCapacityUnits() / 30;

    secondaryLootDiv.innerHTML = `
      <div class="calc-title">Secondary Loot (select what you take)</div>

      <div class="calc-row" style="margin-top: 8px;">
        <span class="calc-meta" style="flex:1;">
          <strong>Suggested fill:</strong>
          Gold <strong>${suggested.Gold}</strong>,
          Paintings <strong>${suggested.Painting}</strong>,
          Cash <strong>${suggested.Cash}</strong>
          <span style="opacity:0.7;">(bag: ${Math.min(capPct, suggestedUsedPct).toFixed(1)}% / ${capPct.toFixed(0)}%)</span>
        </span>
        <button class="calc-btn" id="apply-suggested">Apply</button>
      </div>

      <div class="calc-row">
        <span class="calc-meta">Cash</span>
        <span class="calc-meta">available: ${available.Cash}</span>
        <span class="calc-meta">bag: ${(BAG_PER_STACK_UNITS.Cash/30).toFixed(1)}%</span>
        <input id="take-cash" class="calc-input" type="text" inputmode="decimal" autocomplete="off" spellcheck="false"
               value="${take.Cash}" style="width:90px;">
        <span class="calc-meta">(Enter to sync)</span>
      </div>

      <div class="calc-row">
        <span class="calc-meta">Gold</span>
        <span class="calc-meta">available: ${available.Gold}</span>
        <span class="calc-meta">bag: ${(BAG_PER_STACK_UNITS.Gold/30).toFixed(1)}%</span>
        <input id="take-gold" class="calc-input" type="text" inputmode="decimal" autocomplete="off" spellcheck="false"
               value="${take.Gold}" style="width:90px;">
        <span class="calc-meta">(Enter to sync)</span>
      </div>

      <div class="calc-row">
        <span class="calc-meta">Paintings</span>
        <span class="calc-meta">available: ${available.Painting}</span>
        <span class="calc-meta">bag: ${(BAG_PER_STACK_UNITS.Painting/30).toFixed(0)}%</span>
        <input id="take-painting" class="calc-input" type="text" inputmode="numeric" autocomplete="off" spellcheck="false"
               value="${Math.floor(take.Painting||0)}" style="width:90px;">
        <span class="calc-meta">(Enter to sync)</span>
      </div>
    `;

    const cashInp = document.getElementById('take-cash');
    const goldInp = document.getElementById('take-gold');
    const paintInp = document.getElementById('take-painting');
    const applyBtn = document.getElementById('apply-suggested');

    function commitCashGold(which, rawValue) {
      const maxAvail = which === 'Cash' ? available.Cash : available.Gold;

      let v = parseDecimalInput(rawValue);
      v = Math.max(0, Math.min(maxAvail, v));

      calculatorState.secondary_take[which] = v;

      enforceBagCapacity(which);
      clampSecondaryToAvailable();

      return calculatorState.secondary_take[which];
    }

    function commitPaintings(rawValue) {
      const cleaned = String(rawValue).replace(/[^0-9]/g, '');
      let v = cleaned === '' ? 0 : parseInt(cleaned, 10);
      if (!Number.isFinite(v)) v = 0;

      v = Math.max(0, Math.min(available.Painting, v));
      calculatorState.secondary_take.Painting = v;

      enforceBagCapacity('Painting');
      clampSecondaryToAvailable();

      return calculatorState.secondary_take.Painting;
    }

    async function syncSecondaryTakeAndRefresh() {
      await updateCalculatorState({ secondary_take: calculatorState.secondary_take });
      renderSecondaryControls();
      renderLootResult();
    }

    applyBtn.addEventListener('click', async (e) => {
      e.stopPropagation();

      calculatorState.secondary_take = {
        Cash: suggested.Cash,
        Gold: suggested.Gold,
        Painting: suggested.Painting
      };
      clampSecondaryToAvailable();

      await syncSecondaryTakeAndRefresh();
    });

    cashInp.addEventListener('keydown', async e => {
      e.stopPropagation();
      if (e.key !== 'Enter') return;
      const finalVal = commitCashGold('Cash', cashInp.value);
      cashInp.value = finalVal;
      await syncSecondaryTakeAndRefresh();
    });
    cashInp.addEventListener('blur', async e => {
      const finalVal = commitCashGold('Cash', cashInp.value);
      cashInp.value = finalVal;
      await syncSecondaryTakeAndRefresh();
    });

    goldInp.addEventListener('keydown', async e => {
      e.stopPropagation();
      if (e.key !== 'Enter') return;
      const finalVal = commitCashGold('Gold', goldInp.value);
      goldInp.value = finalVal;
      await syncSecondaryTakeAndRefresh();
    });
    goldInp.addEventListener('blur', async e => {
      const finalVal = commitCashGold('Gold', goldInp.value);
      goldInp.value = finalVal;
      await syncSecondaryTakeAndRefresh();
    });

    paintInp.addEventListener('keydown', async e => {
      e.stopPropagation();
      if (e.key !== 'Enter') return;
      const finalVal = commitPaintings(paintInp.value);
      paintInp.value = finalVal;
      await syncSecondaryTakeAndRefresh();
    });
    paintInp.addEventListener('blur', async e => {
      const finalVal = commitPaintings(paintInp.value);
      paintInp.value = finalVal;
      await syncSecondaryTakeAndRefresh();
    });
  }

  // HUD roll stuff + renderLootResult (unchanged from your paste)
  const hudPrevTextByKey = new Map();

  function prefersReducedMotion() {
    return window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  }

  function extractComparableNumber(str) {
    const m = String(str ?? '').match(/-?\d[\d,]*/);
    if (!m) return null;
    const n = parseInt(m[0].replace(/,/g, ''), 10);
    return Number.isFinite(n) ? n : null;
  }

  function buildRollDigitColumn() {
    const inner = document.createElement('span');
    inner.className = 'roll-digit-inner';
    for (let i = 0; i <= 9; i++) {
      const d = document.createElement('span');
      d.textContent = String(i);
      inner.appendChild(d);
    }
    return inner;
  }

  function setRollDigit(innerEl, digit, immediate) {
    const d = Math.max(0, Math.min(9, parseInt(digit, 10) || 0));
    if (immediate) {
      innerEl.style.transition = 'none';
      innerEl.style.transform = `translateY(${-d}em)`;
      void innerEl.offsetHeight;
      innerEl.style.transition = '';
    } else {
      innerEl.style.transform = `translateY(${-d}em)`;
    }
  }

  function renderRollingText(el, nextText, key) {
    if (!el) return;

    const next = String(nextText ?? '');
    const prev = hudPrevTextByKey.get(key) ?? el.textContent ?? '';

    if (prefersReducedMotion()) {
      el.textContent = next;
      hudPrevTextByKey.set(key, next);
      return;
    }

    const prevNum = extractComparableNumber(prev);
    const nextNum = extractComparableNumber(next);
    const rollUp = (prevNum != null && nextNum != null) ? (nextNum >= prevNum) : true;

    el.innerHTML = '';
    const wrap = document.createElement('span');
    wrap.className = 'roll-number';
    el.appendChild(wrap);

    const maxLen = Math.max(prev.length, next.length);
    const prevP = prev.padStart(maxLen, ' ');
    const nextP = next.padStart(maxLen, ' ');

    for (let i = 0; i < maxLen; i++) {
      const pc = prevP[i];
      const nc = nextP[i];
      const isDigit = (c) => c >= '0' && c <= '9';

      if (isDigit(nc)) {
        const digitBox = document.createElement('span');
        digitBox.className = 'roll-digit';

        const inner = buildRollDigitColumn();
        digitBox.appendChild(inner);
        wrap.appendChild(digitBox);

        const startDigit = isDigit(pc) ? pc : '0';
        setRollDigit(inner, startDigit, true);

        requestAnimationFrame(() => {
          setRollDigit(inner, nc, false);
          void rollUp;
        });
      } else {
        const s = document.createElement('span');
        s.className = 'roll-static';
        s.textContent = (nc === ' ') ? '\u00A0' : nc;
        wrap.appendChild(s);
      }
    }

    hudPrevTextByKey.set(key, next);
  }

  function updateHud(grandTotalMin, grandTotalMax, playerLines) {
    const totalText = (grandTotalMin === grandTotalMax)
      ? `$${Math.floor(grandTotalMin).toLocaleString()}`
      : `$${Math.floor(grandTotalMin).toLocaleString()} - $${Math.floor(grandTotalMax).toLocaleString()}`;

    renderRollingText(hudTotal, totalText, 'hud-total');

    hudPlayers.innerHTML = '';
    (playerLines || []).forEach((line) => {
      const row = document.createElement('div');
      row.className = 'hud-row';
      row.innerHTML = `
        <span class="hud-label">${line.label}</span>
        <span class="hud-subvalue"></span>
      `;
      const valEl = row.querySelector('.hud-subvalue');
      hudPlayers.appendChild(row);

      const key = `player:${line.label}`;
      renderRollingText(valEl, line.value, key);
    });
  }

  function renderLootResult() {
    if (!calculatorState) return;

    const take = calculatorState.secondary_take || { Cash:0, Painting:0, Gold:0 };

    const BAG_CAPACITY_UNITS = getBagCapacityUnits();
    const capPct = BAG_CAPACITY_UNITS / 30;

    const usedUnits = computeBagUsedUnits(take);
    const usedPct = usedUnits / 30;
    const leftUnits = Math.max(0, BAG_CAPACITY_UNITS - usedUnits);
    const leftPct = leftUnits / 30;
    const bagsFull = usedUnits >= BAG_CAPACITY_UNITS;

    bagStatusDiv.innerHTML = bagsFull
      ? `<strong>BAGS FULL</strong> — ${Math.min(capPct, usedPct).toFixed(1)}% / ${capPct.toFixed(0)}%`
      : `<strong>Bag</strong> — ${usedPct.toFixed(1)}% / ${capPct.toFixed(0)}% <span style="opacity:0.8;">(left: ${leftPct.toFixed(1)}%)</span>`;

    const difficulty = calculatorState.difficulty || 'normal';
    const primaryLoot = calculatorState.primary_loot;

    let primaryValue = 0;
    if (primaryLoot) primaryValue = primaryValues[difficulty]?.[primaryLoot] || 0;

    let totalSecondaryMin = 0;
    let totalSecondaryMax = 0;

    Object.entries(secondaryRanges).forEach(([type, range]) => {
      const qty = parseFloat(take[type]) || 0;
      totalSecondaryMin += qty * range[0];
      totalSecondaryMax += qty * range[1];
    });

    const players = calculatorState.players || [];
    const playerCount = players.length;

    const elitePerPlayer = (difficulty === 'hard') ? 100000 : 50000;
    const eliteTotal = elitePerPlayer * playerCount;

    let totalMin = primaryValue + totalSecondaryMin + WALL_SAFE_MIN + eliteTotal;
    let totalMax = primaryValue + totalSecondaryMax + WALL_SAFE_MAX + eliteTotal;

    let grandTotalMin = totalMin * 0.88;
    let grandTotalMax = totalMax * 0.88;

    let html = `<strong>Actual Take:</strong><br>`;
    html += `<span style="opacity:0.8;">(includes Wall Safe: $${WALL_SAFE_MIN.toLocaleString()}–$${WALL_SAFE_MAX.toLocaleString()})</span><br>`;
    html += `<span style="opacity:0.8;">(includes Elite Challenge: $${eliteTotal.toLocaleString()})</span><br>`;

    const hudLines = [];

    players.forEach(p => {
      const cutRaw = parseFloat(p.cut) || 0;
      const cut = cutRaw / 100;
      const minTake = Math.floor(grandTotalMin * cut);
      const maxTake = Math.floor(grandTotalMax * cut);

      html += `${p.name}: $${minTake.toLocaleString()} - $${maxTake.toLocaleString()}<br>`;

      const cutPct = Math.round(cutRaw * 10) / 10;

      hudLines.push({
        label: `${p.name} (${cutPct}%):`,
        value: (minTake === maxTake)
          ? `$${minTake.toLocaleString()}`
          : `$${minTake.toLocaleString()} - $${maxTake.toLocaleString()}`
      });
    });

    lootResultDiv.innerHTML = html;
    updateHud(grandTotalMin, grandTotalMax, hudLines);
  }

  sb.channel('calculator_state')
    .on('postgres_changes', { event: 'UPDATE', table: 'calculator_state' }, payload => {
      setSyncing(false);

      calculatorState = payload.new;
      calculatorState.players = calculatorState.players || [];
      calculatorState.secondary_take = calculatorState.secondary_take || { Cash: 0, Painting: 0, Gold: 0 };
      if (calculatorState.secondary_take.Cash == null) calculatorState.secondary_take.Cash = 0;
      if (calculatorState.secondary_take.Gold == null) calculatorState.secondary_take.Gold = 0;
      if (calculatorState.secondary_take.Painting == null) calculatorState.secondary_take.Painting = 0;

      difficultySelect.value = calculatorState.difficulty || 'normal';
      primaryLootSelect.value = calculatorState.primary_loot || '';

      if (!isCalculatorEditing()) {
        renderPlayers();
        renderSecondaryControls();
      }
      renderLootResult();
    })
    .subscribe();

  loadSymbols();
});
</script>
</body>
</html>
