<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cayo Perico Interactive Map</title>

<style>
html, body {
  margin:0; padding:0;
  user-select:none;
  overflow:hidden;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background:#111;
}

#map-container {
  position:relative;
  width:100vw;
  height:100vh;
  background:url('compound_map.png') no-repeat center center;
  background-size:cover;
}

.zone {
  position:absolute;
  border:2px solid rgba(100,100,100,0.5);
  background-color: rgba(100,100,100,0.3);
  cursor:pointer;
  box-sizing:border-box;
  border-radius:8px;
  transition: all 0.3s ease;
}
.zone:hover {
  border-color:#fff;
  background-color: rgba(100,100,100,0.5);
  box-shadow: 0 0 10px rgba(90,90,90,0.3);
}

.symbol {
  position:absolute;
  width:20%;
  aspect-ratio: 1 / 1;
  display:flex;
  justify-content:center;
  align-items:center;
  cursor:pointer;
  border-radius:50%;
  background-color: rgba(255, 255, 255, 0.8);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.symbol:hover {
  transform: scale(1.2);
  box-shadow: 0 0 10px rgba(255,255,255,0.9);
  background-color: rgba(255, 255, 255, 1);
}

.panel {
  position:absolute;
  background: rgba(40,40,40,0.6);
  color:#fff;
  padding:10px;
  border-radius:10px;
  display:none;
  z-index:10;
  min-width:140px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.5), 0 0 10px rgba(30,30,30,0.5);
  transform-origin: top center;
  transition: transform 0.25s cubic-bezier(0.4,0,0.2,1), opacity 0.25s ease;
  transform: scale(0.9);
  opacity:0;
  backdrop-filter: blur(4px);
}
.panel.show {
  display:block;
  transform: scale(1);
  opacity:1;
}
.panel.show-pop {
  animation: popIn 0.25s forwards;
}
@keyframes popIn {
  0% { transform: scale(0.8); opacity:0; }
  60% { transform: scale(1.05); opacity:1; }
  100% { transform: scale(1); }
}
#panel button {
  background: transparent;
  border: 1px solid #888;
  border-radius:6px;
  color:#fff;
  padding:6px 10px;
  margin:4px 2px;
  cursor:pointer;
  transition: all 0.2s ease;
  font-weight:500;
}
#panel button:hover {
  background: #555;
  box-shadow: 0 0 8px #fff;
  transform: translateY(-2px);
}

#info-panel {
  position: absolute;
  top: 0px; 
  left: 0px;
  width: 25vw; 
  background: rgba(30,30,30,0.8);
  border-radius: 8px;
  overflow: hidden;
  z-index: 20;
  color: #fff;
  box-shadow: 2px 2px 12px rgba(0,0,0,0.7);
  transition: max-height 0.3s ease, opacity 0.3s ease, width 0.3s ease, top 0.3s ease, left 0.3s ease;
  max-height: 100vh;
  backdrop-filter: blur(4px);
}
#info-panel.collapsed {
  width: 175px; 
  top: 30px; 
  left: 30px;
}
#info-header {
  padding: 10px;
  background: rgba(10,10,10,0.6);
  cursor: pointer;
  font-weight: normal;
  transition: background 0.2s ease;
}
#info-header:hover {
  background: rgba(30,30,30,0.6);
}
#info-panel.collapsed #info-content {
  max-height: 0;
  padding: 0 10px;
  opacity: 0;
  overflow: hidden;
  transition: max-height 0.3s ease, opacity 0.3s ease, padding 0.3s ease;
}
#info-content {
  padding: 10px;
  overflow-y: auto;
  max-height: calc(100vh - 50px);
  transition: max-height 0.3s ease, opacity 0.3s ease;
}
#note-input {
  width: calc(100% - 16px);
  padding: 6px 8px;
  margin-top: 6px;
  border-radius: 6px;
  border: 1px solid #555;
  background: rgba(60,60,60,0.8);
  color: #fff;
  outline: none;
  transition: all 0.2s ease;
  box-sizing: border-box;
}
#note-input:focus {
  border-color: #fff;
  background: rgba(60,60,60,1);
  box-shadow: 0 0 6px #fff;
}
.loot-table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 10px;
}
.loot-table th,
.loot-table td {
  border: 1px solid rgba(255,255,255,0.2);
  padding: 4px;
  text-align: center;
}

#calculator {
  background: rgba(50,50,50,0.7);
  padding: 8px;
  margin-top: 10px;
  border-radius: 8px;
  color: #fff;
  font-size: 0.9em;
}
#calculator label { margin-right: 4px; }
#calculator input[type=number], #calculator input[type=text], #calculator select {
  border-radius:4px;
  border:1px solid #555;
  background: rgba(60,60,60,0.8);
  color:#fff;
  padding:2px 4px;
  margin-right:6px;
}
#calculator button {
  background: transparent;
  border: 1px solid #888;
  border-radius:4px;
  color:#fff;
  padding:2px 6px;
  margin-right:4px;
  cursor:pointer;
}
#calculator button:hover { background:#555; box-shadow:0 0 6px #fff; }
#calculator .player-row { display:flex; align-items:center; margin-bottom:4px; gap:6px; }
#calculator .loot-result { margin-top:6px; background: rgba(30,30,30,0.5); padding:4px; border-radius:6px; }
</style>
</head>

<body>

<div id="info-panel" class="collapsed">
  <div id="info-header">Loot Panel ▼</div>
  <div id="info-content">
    <table class="loot-table">
      <tr><th>Primary Loot</th><th>Normal</th><th>Hard</th><td>Rarity &lt;72H</td><td>Rarity &gt;72H</td></tr>
      <tr><td>Tequila</td><td>$630k</td><td>$693k</td><td>47.6%</td><td>25%</td></tr>
      <tr><td>Ruby</td><td>$700k</td><td>$770k</td><td>19%</td><td>25%</td></tr>
      <tr><td>Bonds</td><td>$770k</td><td>$847k</td><td>28.6%</td><td>37.5%</td></tr>
      <tr><td>Diamond</td><td>$1.3mil</td><td>$1.43mil</td><td>4.8%</td><td>12.5%</td></tr>
      <tr><td>Panther</td><td>$1.9mil</td><td>$2.09mil</td><td>Events</td><td>Events</td></tr>
    </table>

    <table class="loot-table">
      <tr><th>Secondary Loot</th><th>Bag %</th><th>Value Stack</th></tr>
      <tr><td>Wall Safe</td><td>0%</td><td>$20k–$99k</td></tr>
      <tr><td>Cash</td><td>25%</td><td>$78k–$89k</td></tr>
      <tr><td>Painting</td><td>50%</td><td>$176k–$199k</td></tr>
      <tr><td>Gold</td><td>66.7%</td><td>$328k–$333k</td></tr>
    </table>

    <table class="loot-table">
      <tr><th>Fee</th><th>Cut %</th></tr>
      <tr><td>Pavel Cut</td><td>2%</td></tr>
      <tr><td>Fencing Fee</td><td>10%</td></tr>
    </table>

    <div id="calculator">
      <div>
        <label>Difficulty:</label>
        <select id="difficulty-select">
          <option value="normal">Normal</option>
          <option value="hard">Hard</option>
        </select>
      </div>
      <div>
        <label>Primary Loot:</label>
        <select id="primary-loot-select">
          <option value="">-- Select --</option>
          <option value="Tequila">Tequila</option>
          <option value="Ruby">Ruby</option>
          <option value="Bonds">Bonds</option>
          <option value="Diamond">Diamond</option>
          <option value="Panther">Panther</option>
        </select>
      </div>
      <div id="player-cuts"></div>
      <div id="secondary-loot-selection"></div>
      <div class="loot-result" id="loot-result"></div>
    </div>

    <div id="notes-container"></div>
    <input id="note-input" placeholder="Add a note...">
  </div>
</div>

<div id="map-container">
  <div class="zone" style="left:47%;top:54%;width:6%;height:5%;" data-name="Vault"></div>
  <div class="zone" style="left:45%;top:48%;width:6%;height:5%;" data-name="Office"></div>
  <div class="zone" style="left:53%;top:46%;width:6%;height:5%;" data-name="North Storage"></div>
  <div class="zone" style="left:63%;top:62%;width:6%;height:5%;" data-name="West Storage"></div>
  <div class="zone" style="left:47%;top:65%;width:6%;height:5%;" data-name="South Storage"></div>
</div>

<div id="panel" class="panel">
  <h3 id="panel-title"></h3>
  <button data-symbol="Gold">Gold</button>
  <button data-symbol="Cash">Cash</button>
  <button data-symbol="Painting">Painting</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const sb = supabase.createClient(
    'https://qanrnafvvnmimewtxrxv.supabase.co',
    'sb_publishable_8F3cI7ZKCgpxv6UfaRJn7A_r1s17TmC'
  );

  const infoContent = document.getElementById('info-content');
  const difficultySelect = document.getElementById('difficulty-select');
  const primaryLootSelect = document.getElementById('primary-loot-select');
  const playerCutsDiv = document.getElementById('player-cuts');
  const secondaryLootDiv = document.getElementById('secondary-loot-selection');
  const lootResultDiv = document.getElementById('loot-result');

  let calculatorState = null;
  const secondaryLootTypes = ['Cash','Painting','Gold'];
  const secondaryRanges = {
    Cash:[78000,89000],
    Painting:[176000,199000],
    Gold:[328000,333000]
  };
  const secondaryBagPerc = { Cash:0.25, Painting:0.5, Gold:0.667 };

  async function loadCalculator() {
    const { data } = await sb.from('calculator_state').select('*').limit(1).single();
    if(!data) { 
      calculatorState = {id:1, players:[], difficulty:'normal', primary_loot:''}; 
      renderPlayers(); renderSecondaryLoot(); renderLootResult(); 
      return;
    }
    calculatorState = data;
    difficultySelect.value = calculatorState.difficulty || 'normal';
    primaryLootSelect.value = calculatorState.primary_loot || '';
    renderPlayers(); renderSecondaryLoot(); renderLootResult();
  }

  function renderPlayers() {
    playerCutsDiv.innerHTML = '';
    (calculatorState.players||[]).forEach((p, idx)=>{
      const div = document.createElement('div');
      div.className = 'player-row';
      div.innerHTML = `
        <input type="text" value="${p.name}" data-idx="${idx}">
        <input type="number" min="0" max="100" value="${p.cut}" data-idx="${idx}">
        <button data-idx="${idx}">Remove</button>
      `;
      playerCutsDiv.appendChild(div);
    });
    if((calculatorState.players||[]).length<3){
      const btn = document.createElement('button'); btn.textContent='Add Player';
      btn.onclick = async()=>{
        calculatorState.players.push({name:'Player '+(calculatorState.players.length+1), cut:0});
        await updateCalculatorState({players:calculatorState.players});
        renderPlayers(); renderLootResult();
      };
      playerCutsDiv.appendChild(btn);
    }

    // Attach events
    playerCutsDiv.querySelectorAll('input[type=text]').forEach(inp=>{
      inp.addEventListener('input', async e=>{
        calculatorState.players[e.target.dataset.idx].name=e.target.value;
        await updateCalculatorState({players:calculatorState.players});
      });
    });
    playerCutsDiv.querySelectorAll('input[type=number]').forEach(inp=>{
      inp.addEventListener('input', async e=>{
        calculatorState.players[e.target.dataset.idx].cut=Math.min(100,parseInt(e.target.value)||0);
        enforceBagLimit();
        await updateCalculatorState({players:calculatorState.players});
        renderLootResult();
      });
    });
    playerCutsDiv.querySelectorAll('button').forEach(btn=>{
      btn.addEventListener('click', async e=>{
        calculatorState.players.splice(btn.dataset.idx,1);
        enforceBagLimit();
        await updateCalculatorState({players:calculatorState.players});
        renderPlayers(); renderLootResult();
      });
    });
  }

  difficultySelect.addEventListener('change', async ()=> {
    calculatorState.difficulty=difficultySelect.value;
    await updateCalculatorState({difficulty:calculatorState.difficulty});
    renderLootResult();
  });
  primaryLootSelect.addEventListener('change', async ()=>{
    calculatorState.primary_loot=primaryLootSelect.value;
    await updateCalculatorState({primary_loot:calculatorState.primary_loot});
    renderLootResult();
  });

  function enforceBagLimit(){
    const total = calculatorState.players.reduce((sum,p)=>sum+p.cut,0);
    if(total>300){
      const ratio = 300/total;
      calculatorState.players.forEach(p=>p.cut=Math.floor(p.cut*ratio));
    }
  }

  async function updateCalculatorState(updates){
    await sb.from('calculator_state').update(updates).eq('id',calculatorState.id);
    Object.assign(calculatorState,updates);
  }

  function getSymbolCounts(){
    const counts={cash:0,painting:0,gold:0};
    document.querySelectorAll('.symbol').forEach(s=>{
      const img=s.querySelector('img')?.src.toLowerCase();
      if(img?.includes('dollar')) counts.cash++;
      if(img?.includes('painting')) counts.painting++;
      if(img?.includes('gold')) counts.gold++;
    });
    return counts;
  }

  function renderSecondaryLoot(){
    secondaryLootDiv.innerHTML='';
    const counts=getSymbolCounts();
    secondaryLootTypes.forEach(type=>{
      const available=counts[type.toLowerCase()]||0;
      const maxTake=Math.floor(available*secondaryBagPerc[type]);
      const div=document.createElement('div');
      div.style.marginBottom='4px'; div.style.display='flex'; div.style.alignItems='center'; div.style.gap='6px';
      div.innerHTML=`<label>${type} (available:${available}):</label>
      <input type="number" min="0" max="${maxTake}" value="0" data-type="${type}">`;
      secondaryLootDiv.appendChild(div);
    });
  }

  function renderLootResult(){
    const primaryValues = {
      normal: {Tequila:630000,Ruby:700000,Bonds:770000,Diamond:1300000,Panther:1900000},
      hard: {Tequila:693000,Ruby:770000,Bonds:847000,Diamond:1430000,Panther:2090000}
    };
    let primaryValue=0;
    if(calculatorState.primary_loot) primaryValue=primaryValues[calculatorState.difficulty][calculatorState.primary_loot]||0;
    const secondaryInputs=secondaryLootDiv.querySelectorAll('input');
    let secMin=0, secMax=0;
    secondaryInputs.forEach(inp=>{
      const type=inp.dataset.type; const val=parseInt(inp.value)||0;
      const range=secondaryRanges[type]; secMin+=val*range[0]; secMax+=val*range[1];
    });
    let totalMin=(primaryValue+secMin)*0.88;
    let totalMax=(primaryValue+secMax)*0.88;
    let html='<strong>Potential Take:</strong><br>';
    (calculatorState.players||[]).forEach(p=>{
      const minTake=Math.floor(totalMin*(p.cut/100));
      const maxTake=Math.floor(totalMax*(p.cut/100));
      html+=`${p.name}: $${minTake.toLocaleString()} → $${maxTake.toLocaleString()}<br>`;
    });
    lootResultDiv.innerHTML=html;
  }

  secondaryLootDiv.addEventListener('input', renderLootResult);

  sb.channel('calculator_state')
    .on('postgres_changes', { event: 'UPDATE', table: 'calculator_state' }, payload=>{
      calculatorState=payload.new;
      difficultySelect.value=calculatorState.difficulty;
      primaryLootSelect.value=calculatorState.primary_loot||'';
      renderPlayers(); renderSecondaryLoot(); renderLootResult();
    }).subscribe();

  loadCalculator();
});
</script>
</body>
</html>
