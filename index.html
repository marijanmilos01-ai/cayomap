<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cayo Perico Interactive Map</title>
<style>
html, body { margin:0; padding:0; user-select:none; overflow:hidden; font-family:Arial,sans-serif; }
#map-container { position:relative; width:100vw; height:100vh; background:url('compound_map.png') no-repeat center center; background-size:cover; }
.zone { position:absolute; border:2px solid #ccc; background-color:rgba(200,200,200,0.3); cursor:pointer; box-sizing:border-box; transition:0.2s; border-radius:8px; }
.zone:hover { border-color:#ddd; background-color:rgba(220,220,220,0.4); }
.symbol { position:absolute; width:30%; height:45%; display:flex; justify-content:center; align-items:center; cursor:pointer; transition:0.2s; background-color:rgba(255,255,255,0.4); border-radius:50%; }
.symbol:hover { transform:scale(1.1); background-color:rgba(255,255,255,0.6); }
.panel { position:absolute; background:rgba(30,30,30,0.9); color:#fff; padding:10px; border-radius:8px; display:none; z-index:10; min-width:120px; }
.panel button { margin:5px; padding:5px 10px; cursor:pointer; border:none; border-radius:6px; background-color:rgba(60,60,60,0.8); color:#fff; transition:0.2s; }
.panel button:hover { background-color:rgba(100,100,100,0.9); transform:scale(1.05); }
.panel h3 { margin:0 0 5px 0; font-size:1em; font-weight:bold; }
#info-panel { position:absolute; top:10px; left:10px; width:250px; max-height:400px; background:rgba(30,30,30,0.9); border-radius:8px; overflow:hidden; transition:max-height 0.3s ease; z-index:20; color:#fff; }
#info-header { padding:8px; background:rgba(50,50,50,0.95); cursor:pointer; font-weight:bold; border-bottom:1px solid rgba(100,100,100,0.3); }
#info-content { padding:8px; display:block; background:rgba(50,50,50,0.7); }
#notes-container div { padding:4px 6px; margin-bottom:4px; background:rgba(100,100,100,0.5); border-radius:4px; cursor:pointer; color:#fff; }
#note-input { width:100%; box-sizing:border-box; margin-top:5px; padding:5px; border-radius:4px; border:1px solid #555; background:rgba(60,60,60,0.7); color:#fff; }
</style>
</head>
<body>

<div id="info-panel">
  <div id="info-header">Info Panel &#9650;</div>
  <div id="info-content">
    <div id="notes-container"></div>
    <input type="text" id="note-input" placeholder="Add a note...">
  </div>
</div>

<div id="map-container">
  <div id="zone1" class="zone" style="left:47%;top:54%;width:6%;height:5%;" data-name="Podrum"></div>
  <div id="zone2" class="zone" style="left:45%;top:48%;width:6%;height:5%;" data-name="Office"></div>
  <div id="zone3" class="zone" style="left:53%;top:46%;width:6%;height:5%;" data-name="North Storage"></div>
  <div id="zone4" class="zone" style="left:63%;top:62%;width:6%;height:5%;" data-name="West Storage"></div>
  <div id="zone5" class="zone" style="left:47%;top:65%;width:6%;height:5%;" data-name="South Storage"></div>
</div>

<div id="panel" class="panel">
  <h3 id="panel-title">Zone</h3>
  <button data-symbol="Gold">Gold</button>
  <button data-symbol="Cash">Cash</button>
  <button data-symbol="Painting">Painting</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const supabaseClient = supabase.createClient(
  'https://qanrnafvvnmimewtxrxv.supabase.co',
  'sb_publishable_8F3cI7ZKCgpxv6UfaRJn7A_r1s17TmC'
);

const zones = document.querySelectorAll('.zone');
const panel = document.getElementById('panel');
const panelTitle = document.getElementById('panel-title');
let activeZone = null;

// Track rendered symbols to avoid duplicates
const renderedSymbols = new Set();

// Show panel
zones.forEach(zone=>{
  zone.addEventListener('click', e=>{
    e.stopPropagation();
    activeZone = zone;
    panelTitle.textContent = zone.dataset.name;
    const rect = zone.getBoundingClientRect();
    const panelHeight = 100;
    panel.style.top = rect.top > window.innerHeight/2 ? (rect.top-panelHeight-10)+'px' : (rect.bottom+10)+'px';
    panel.style.left = rect.left+'px';
    panel.style.display='block';
  });
});

document.addEventListener('click', e=>{
  if(!panel.contains(e.target) && !e.target.classList.contains('zone')){
    panel.style.display='none';
    activeZone = null;
  }
});

// Add symbol
function addSymbolToZone(zone, type, key=null){
  const symbolKey = key || `${zone.dataset.name}_${type}`;
  if(renderedSymbols.has(symbolKey)) return;
  renderedSymbols.add(symbolKey);

  const existing = zone.querySelectorAll('.symbol');
  if(existing.length >=6) return;

  const idx = existing.length;
  const row = idx<3?0:1;
  const col = idx%3;

  const symbol = document.createElement('div');
  symbol.classList.add('symbol');
  symbol.style.top = `${row*50+2}%`;
  symbol.style.left = `${col*33+1}%`;
  symbol.dataset.key = symbolKey;

  let svg='';
  switch(type){
    case 'Gold': svg=`<img src="https://www.svgrepo.com/show/323883/gold-bar.svg" width="100%" height="100%">`; break;
    case 'Cash': svg=`<img src="https://www.svgrepo.com/show/507663/dollar-circle.svg" width="100%" height="100%">`; break;
    case 'Painting': svg=`<img src="https://www.svgrepo.com/show/535548/painting.svg" width="100%" height="100%">`; break;
  }
  symbol.innerHTML=svg;

  symbol.addEventListener('click', e=>{
    e.stopPropagation();
    symbol.remove();
    renderedSymbols.delete(symbolKey);
    supabaseClient.from('symbols').delete().eq('region',zone.dataset.name).eq('symbol',type).limit(1).then(()=>{});
  });

  zone.appendChild(symbol);
  return symbolKey;
}

// Panel buttons
panel.querySelectorAll('button').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    if(!activeZone) return;
    const key = addSymbolToZone(activeZone, btn.dataset.symbol);
    if(key) supabaseClient.from('symbols').insert({region:activeZone.dataset.name,symbol:btn.dataset.symbol}).then(()=>{});
  });
});

// Info panel
const infoHeader = document.getElementById('info-header');
const infoContent = document.getElementById('info-content');
const notesContainer = document.getElementById('notes-container');
const noteInput = document.getElementById('note-input');
let collapsed=false;
infoHeader.addEventListener('click', ()=>{
  if(collapsed){
    infoContent.style.display='block';
    document.getElementById('info-panel').style.maxHeight='400px';
    infoHeader.innerHTML="Info Panel &#9650;";
    collapsed=false;
  } else{
    infoContent.style.display='none';
    document.getElementById('info-panel').style.maxHeight='40px';
    infoHeader.innerHTML="Info Panel &#9660;";
    collapsed=true;
  }
});

// Notes
noteInput.addEventListener('keydown', e=>{
  if(e.key==='Enter' && noteInput.value.trim()!==''){
    const content=noteInput.value.trim();
    const noteDiv=document.createElement('div');
    noteDiv.textContent=content;
    noteDiv.addEventListener('click', ()=>{
      noteDiv.remove();
      supabaseClient.from('notes').delete().eq('content',content).limit(1).then(()=>{});
    });
    notesContainer.appendChild(noteDiv);
    supabaseClient.from('notes').insert({content}).then(()=>{});
    noteInput.value='';
  }
});

// Load initial data
async function loadData(){
  const {data:symbols} = await supabaseClient.from('symbols').select('*');
  symbols.forEach(s=>{
    const zoneEl=document.querySelector(`.zone[data-name="${s.region}"]`);
    if(zoneEl) addSymbolToZone(zoneEl,s.symbol,`${s.region}_${s.symbol}_${s.id}`);
  });

  const {data:notes} = await supabaseClient.from('notes').select('*');
  notes.forEach(n=>{
    const noteDiv=document.createElement('div');
    noteDiv.textContent=n.content;
    noteDiv.addEventListener('click', ()=>{
      noteDiv.remove();
      supabaseClient.from('notes').delete().eq('content',n.content).limit(1).then(()=>{});
    });
    notesContainer.appendChild(noteDiv);
  });
}
loadData();

// Realtime
supabaseClient.channel('public:symbols')
  .on('postgres_changes',{event:'INSERT',schema:'public',table:'symbols'}, payload=>{
    const zoneEl=document.querySelector(`.zone[data-name="${payload.new.region}"]`);
    if(zoneEl) addSymbolToZone(zoneEl,payload.new.symbol,`${payload.new.region}_${payload.new.symbol}_${payload.new.id}`);
  })
  .on('postgres_changes',{event:'DELETE',schema:'public',table:'symbols'}, payload=>{
    loadData();
  }).subscribe();

supabaseClient.channel('public:notes')
  .on('postgres_changes',{event:'INSERT',schema:'public',table:'notes'}, payload=>{
    const noteDiv=document.createElement('div');
    noteDiv.textContent=payload.new.content;
    noteDiv.addEventListener('click', ()=>{
      noteDiv.remove();
      supabaseClient.from('notes').delete().eq('content',payload.new.content).limit(1).then(()=>{});
    });
    notesContainer.appendChild(noteDiv);
  })
  .on('postgres_changes',{event:'DELETE',schema:'public',table:'notes'}, payload=>{
    loadData();
  }).subscribe();

</script>
</body>
</html>
